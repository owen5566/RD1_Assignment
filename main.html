<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="css/bootstrap4/bootstrap.min.css">
    <link rel="stylesheet" href="css/font-awesome/css/font-awesome.min.css">
    <script src="js/jquery-3.2.1.min.js"></script>
    <script src="css/bootstrap4/popper.js"></script>
    <script src="css/bootstrap4/bootstrap.min.js"></script>
    <style>
        .card{
            margin: 20px;
        }
        .title{
            font-size:x-large;
            color: gray;
            padding: 20px;
        }
        .s{
            font-size: x-small;
        }
        table { 
            table-layout: fixed; 
        }

    </style>
</head>
<body>
    <div class="container">
        <nav class="navbar bg-light">
            <a class="navbar-brand">title here</a>
            <form class="form-inline">
                <label for="citys"> 選擇縣市：</label>
                <select class ="custom-select" name="city" id="city">
                </select>
            </form>
          </nav>
        <div id ="titleCity" class="row title">臺北市</div>
        <div id = "card3" class="row">
            <div id = "today" class="card col">
                <img src="" class="card-img-top" alt="...">
                <div class="card-body">
                  <h5 class="card-title">今天</h5>
                  <p id="wx" class="card-text"></p>

                  <p id="tempRange" class="card-text">25~31</p>
                  <i id ="pop" class="fa fa-umbrella"title="降雨機率">降雨機率 10%</i>
                  <br>
                  <i id ="uvi" class="fa fa-sun-o" title="紫外線指數">紫外線指數 ９</i>

                </div>
              </div>
              
        </div>
        <div id ="titleCity" class="row title">未來一週預報</div>

        <table id="future7" class="table">
            <thead>
              <tr id = "trDate">
                
              </tr>
            </thead>
            <tbody >
              <tr id="trDay">
                
              </tr>
              <tr id="trNight" class="table-active">
               
              </tr>
            
            </tbody>
          </table>
    </div>
<script>
    $(function(){
        let today = new Date();
        let day = (today.getDay());
        // setInterval(()=>{
        //     console.log()
        // }, 1000);
        getCityList();
        $("#city").change(function(){
            let geocodeToServer = $("#city").find(":selected").val();
            $("#titleCity").text($("#city").find(":selected").text())
            getWeather(geocodeToServer);
            
            // for(let i = 0 ;i < weatherObj.)
        })
        getWeather("63");
        function getCityList(){
            $.ajax({
            type:"POST",
            url:"api/getCity",
            }).then(function(e){
            cityArr = JSON.parse(e);
            // console.log(cityArr);
            cityArr.forEach(element => {
                if(element=="success"){return true;}
                  $("#city").append(
                  $("<option class = 'cityOptions'/>").val(element.geoCode).text(element.cityName)
              )  
            })
        })

        }
        function getWeather(geocode){
            $.ajax({
                type:"POST",
                url:"api/getWeather",
                data:{geocode:geocode}
            }).then(function(e){
                weatherObj = JSON.parse(e);
                // console.log(weatherObj);
                let dateArr = Array();
                let weatherArr = Array();
                let count = 0;
                weatherObj.forEach(element =>{
                    if(element=="success"){return true;}
                    /// 
                    let temp = new Date(element.startTime);
                    let tempDate = (temp.getMonth()+1)+"/"+temp.getDate();
                    if(count==0){let tempDay = temp.getDay();dateArr.push(tempDay);count++;}
                    if(!(dateArr.includes(tempDate))){
                        dateArr.push(tempDate);
                    }
                    weatherArr.push([element.PoP12h,element.minTemp,element.maxTemp,element.wx,element.UVI,element.startTime,element.endTime])
                });
                console.log(weatherArr);
                
                //明後天
                $("#card3").html("");
                let str={
                        0:"今日",
                        2:"明日白天",
                        4:"後天白天"
                    }
                for(i=0;i<6;i+=2){
                    
                    $("#card3").append(
                    `<div id = "today" class="card col">
                    <img src="" class="card-img-top" alt="...">
                    <div class="card-body">
                    <h5 class="card-title">${str[i]}</h5>
                    <p id="wx" class="card-text"></p>
                    <p id="tempRange" class="card-text">${weatherArr[i][1]}~${weatherArr[i][2]}°C</p>
                    <i id ="pop" class="fa fa-umbrella"title="降雨機率">降雨機率 ${weatherArr[i][0]}%</i>
                    <br>
                    <i id ="uvi" class="fa fa-sun-o" title="紫外線指數">紫外線指數 ${weatherArr[i][4]}</i>
                    </div>
                    </div>`
                    )
                }
                // 一週預報
                let dayArr=["星期天","星期一","星期二","星期三","星期四","星期五","星期六"]
                $("#trDate").html("");
                $("#trDay").html("");
                $("#trNight").html("");

                for(i=1;i<dateArr.length;i++){
                    $("#trDate").append(
                        $("<th/>").html(dateArr[i]+"<br>"+dayArr[(dateArr[0]+i-1)%7])
                    )
                }
                for(i=0;i<weatherArr.length;i+=2){
                    $("#trDay").append(
                        $("<td />").html(
                            `<div class="row justify-content-center s">${weatherArr[i][3]}</div>`+
                            `<div class="row justify-content-center">${weatherArr[i][1]}~${weatherArr[i][2]}°C</div>`
                        )
                    )
                }
                for(i=1;i<weatherArr.length;i+=2){
                    $("#trNight").append(
                        $("<td />").html(
                            `<div class="row justify-content-center s">${weatherArr[i][3]}</div>`+
                            `<div class="row justify-content-center">${weatherArr[i][1]}~${weatherArr[i][2]}°C</div>`
                        )
                    )
                }
                
            })
        }
    })
</script>
</body>
</html>